<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/tss_base.css">
  <title>Track Space Sale</title>
</head>
<!-- HTML -->
<body>
  <header>共同配送モデル</header>
  <a class="user" href="/trackapp_regi.html">ユーザー登録はこちら</a>
  <main>
      <div class="upper">

        <section class="map_area">
          <div id="myMap"style="width: 100%; height: 350px;"></div>
        </section>
        <section class="input_area">
          <ul>
            <li><p class="inpbox">When？</p><select class="year" name="year"></select><select class="month" name="month"></select><select class="date" name="date"></select></li>
            <li><p class="inpbox">Where from？</p><input type="text" placeholder="東京都千代田区" class="where_from"></li>
            <li><p class="inpbox">Where to？</p><input type="text" placeholder="岩手県北上" class="where_to"></li>
            <li><p class="inpbox">What？</p>
              <div class="what"><div class="whatbox">Weight<div class="inputzone"><input type="text" class="inp_what weight" placeholder="500"><select class="wei_unit"><option value="kg">kg</option><option value="mt">MT</option></select></div></div></li>
            <li><p class="inpbox" ></p>  
              <div class="what"><div class="whatbox">Length<div class="inputzone"><input type="text" class="inp_what length" placeholder="5000"><select class="len_unit"><option value="mm">mm</option><option value="m">m</option></select></div></div></li>
            <li><p class="inpbox" ></p>  
              <div class="what"><div class="whatbox">Width <div class="inputzone"><input type="text" class="inp_what width" placeholder="300"><select class="wid_unit"><option  value="mm">mm</option><option value="m">m</option></select></div></div></li>
              <li><p class="inpbox" ></p>  
                <div class="what"><div class="whatbox">Height <div class="inputzone"><input type="text" class="inp_what height" placeholder="300"><select class="hei_unit"><option value="mm">mm</option><option value="m">m</option></select></div></div></li>  
            <li><p class="inpbox">How match?</p>
              <div class="what"><div class="whatbox"> <div class="inputzone"><input type="text" class="inp_what price" placeholder="300"><select class="pri_unit"><option>円</option><option>$</option></select></div></div></li>
            <li class="ser_sub" style="justify-content: center;">
              <form style="display: flex;">
                <button type="button" style="text-align: center; margin:auto; width: 80%;" class="search">Search</button>
                <button type="button" style="text-align: center; margin:auto; width: 80%;" class="submit">Submit</button>
              </form>
            </li>
            </ul>
        </section>
      </div> 

      <div class="under">
        <section class="track_side">
          <div class="track_zone">
            Above Track (上部図示)
              <div class="track_select"><select class="select_track" style="width:45%;"><option>平ボディ</option><option>バン</option>
                                        </select><select style="width: 45%;"  class="abo_track_kind"><option>4MT</option><option>10MT</option><option>20MT</option></select>
            </div>
          <canvas id="canvas_ans" style="height: 150px; border:1px solid; background-color: white;"></canvas>
          </div>
          <ul class="box">
            <p style="margin-bottom: 4%;">Plan to Use<br>【Current Add】</p>
            <div class="ans"><li class="li_tag">Weight</li><p class="ans_wei"></p></div> 
            <div class="ans"><li class="li_tag">Length</li><p class="ans_len"></p></div>
            <div class="ans"><li class="li_tag">Width</li><p class="ans_wid"></p></div>
            <div class="ans"><li class="li_tag">Height</li><p class="ans_hei"></p></div>
          </ul>
          <ul class="box">
            <p style="margin-bottom: 4%;">Usage</p>
            <div class="ans a_usage"><li class="li_tag">Weight</li><p class="ans_wei_usage"></p></div> 
            <div class="ans a_usage"><li class="li_tag">Square mm</li><p class="ans_len_usage"></p></div>
          </ul>
        </section>
        <section class="track_side">
          <div class="track_zone">
           Side Track(側面図示)
           <div>
              <!-- <div class="track_select"><select class="select_track" style="width:45%;"><option>バン</option><option>平ボディ</option>
                                        </select><select style="width: 45%;" class="side_track_kind"><option>4MT</option><option>10MT</option><option>20MT</option></select> -->
            </div>
          <canvas id="canvas_ana" class="canvas_ana" style="height:150px; border:1px solid;background-color: white;"></canvas>
          </div>
          <ul class="box">
            <p style="margin-bottom: 4%;">Plan to Use<br>【Current Add】</p>
            <div class="ana"><li class="li_tag">Weight</li><p class="ana_wei"></p></div> 
            <div class="ana"><li class="li_tag">Length</li><p class="ana_len"></p></div>
            <div class="ana"><li class="li_tag">Width</li><p class="ana_wid"></p></div>
            <div class="ana"><li class="li_tag">Height</li><p class="ana_hei"></p></div>
          </ul>
        </section>
        <section class="list" style="width: 28%;">
          <div class="track_zone list_zone">
            Send List
          </div>
          <ul class="box list_box">
          </ul>
        </section>
      </div>  

      <form class="form_regi submit_tab" name="login_form" style="z-index: 10000;" hidden >
        <div class="login_form_top">
          <h1>以下内容のメールを登録者に送信します。よろしいでしょうか？</h1>
          <h2>【積載募集】</h2>
          <div class="email_content_date"><li class="mail_date"><p>日付</p><p class="dated"></p></li></div>
          <div class="email_content_money"><li class="mail_money"><p>金額</p><p class="money"></p></li></div>
          <div class="email_content_amount"><li class="mail_amount"><p>重量</p><p class="amount"></p></li></div>
          <div class="email_content_space"></div>
          <div class="email_address" ><li class="mail_amount"><p></p><p class="email"></p></li></div>
        </div>
        <div class="login_form_btm">
          <button class="confirm">送る</button>
          <button class="reject">送らない</button>
        </div>
      </form>

      <form class="form_regi opening" name="login_form" style="z-index: 40000;" hidden>
        <div class="login_form_top">
          <h1>ようこそ！！</h1>
          <h2>共配モデルとは？</h2>
          <div class="content" style="margin:2% auto 5% auto; border-style: solid;border-color: black;border-width: 2px; border-radius: 5px; background-color: white;">
            <h2 style="margin-top:2%;">目的</h2>
            <p style="font-size:16px; margin:2% auto 2% auto; text-align: left;">共同配送モデルはトラックの空きを埋めることを目的とした共同配送システムです。自社の物品と一緒に他社の製品を運ぶ事で効率的な物流を目指します。</p>
          </div>
          <div class="content" style="margin:2% auto 5% auto; border-style: solid;border-color: black;border-width: 2px; border-radius: 5px; background-color: white;">
            <h2 style="margin-top:2%;">使い方</h2>
            <p style="font-size:16px; margin:2% auto 2% auto; text-align:left;">①基本項目(配送日/配送先/配送元/サイズ/募集価格)<br>②Searchボタンで荷台に積んだ荷物が図示されます<br>③全て荷物を積み込んだら、SubmitからSendリスト先に募集をかけましょう。</p>
          </div>
          <button class="close">閉じる</button>
        </div>
      </form>
  </main>
</html>
<!-- JS -->
<!-- インストール -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
<script src="https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=Arz7ZFPt6gmLqT_q_qAfIkQXVTkOiB_AZic9lTPzwA4HaAPSqZhteb7kF4mt8nYv" async defer></script>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
  import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved  }
      from "https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-database.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "",
    authDomain: "trackbase-c1fc9.firebaseapp.com",
    projectId: "trackbase-c1fc9",
    storageBucket: "trackbase-c1fc9.appspot.com",
    messagingSenderId: "375417776999",
    appId: "1:375417776999:web:5cbfc2d0b80c3c68559dc2",
    measurementId: "G-9JLWN73EXF"
  };
// Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);//Real Time DBに接続
  const dbRef = ref(db,"space");//Realtime DB
  const dbRef_add = ref(db,"user");

//Initialization processing→Bing map使用した場合
let map;
let searchManager;
window.onload =function GetMap() {
    map = new Microsoft.Maps.Map('#myMap', {
        center: new Microsoft.Maps.Location(35.6797, 139.7647), //Location center position
        mapTypeId: Microsoft.Maps.MapTypeId.load, //aerial,canvasDark,canvasLight,birdseye,grayscale,streetside
        zoom: 12  //Zoom:1=zoomOut ~ 20=zoomUp
    });



///////////////////////////////////////////////////////////セレクトボックス日付選択/////////////////////////////////////////////////////////////////////////////////////////////////////
for(let i = 2023; i < 2051; i++){
  $(".year").append(`<option>${i}</option>`)
}
for(let i = 1; i <13; i++){
  $(".month").append(`<option>${i}</option>`)
}
for(let i = 1; i <32; i++){
  $(".date").append(`<option>${i}</option>`)
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



///////////////////////////////////////////////////////////////////////////マップ上に表示/////////////////////////////////////////////////////////////////////////////////////
//入力値に合わせて範囲円を成形
$(".search").on("click",function(){
//サークル設定
    const style = {
    pinColor:"#0000ff",
    fillColor:"rgba(0,0,100,0.4)",
    strokeWidth:5
    };
//サークルの大きさ
const meter = 3000;
Microsoft.Maps.loadModule('Microsoft.Maps.Search', function () {
Microsoft.Maps.loadModule("Microsoft.Maps.SpatialMath", function () {
  //searchManagerインスタンス化（Geocode,ReverseGeocodeが使用可能になる）
  searchManager = new Microsoft.Maps.Search.SearchManager(map);
  //Geocode：住所から検索
  geocodeQuery($(".where_from").val());
   });
  //Geocode:住所から検索
  geocodeQuery(document.getElementsByClassName("where_from").value);
    //住所緯度から住所を取得
    function geocodeQuery(query) {
        if(searchManager) {
            //住所から緯度経度を検索
            searchManager.geocode({
                where: query,       //検索文字列
                callback: function (r) { //検索結果を"( r )" の変数で取得
                    //最初の検索取得結果をMAPに表示
                    if (r && r.results && r.results.length > 0) {
                        //正確なサークルを作成する
                        const path = Microsoft.Maps.SpatialMath.getRegularPolygon(r.results[0].location, meter, 36, Microsoft.Maps.SpatialMath.Meters);
                       
                        //センターとなる緯度経度の取得//////////////////////////
                        const lat = r.results[0].location.latitude;
                        const lon = r.results[0].location.longitude;
                        localStorage.setItem("lat_dep",lat);
                        localStorage.setItem("lon_dep",lon);
                        ///////////////////////////////////////////////////

                        const poly = new Microsoft.Maps.Polygon(path,{
                        fillColor: style.fillColor,
                        strokeThickness: style.strokeWidth
                        });
                        map.entities.push(poly);
                        map.setView({ bounds: r.results[0].bestView});
                    }
                },
                errorCallback: function (e) {
                }
            });
        }
      }
})})
$(".search").on("click",function(){
//サークル設定
    const style = {
    pinColor:"#ff0000",
    fillColor:"rgba(255, 0 , 0, 0.5)",
    strokeWidth:5
    };
//サークルの大きさ
const meter = 3000;
Microsoft.Maps.loadModule('Microsoft.Maps.Search', function () {
Microsoft.Maps.loadModule("Microsoft.Maps.SpatialMath", function () {
  //searchManagerインスタンス化（Geocode,ReverseGeocodeが使用可能になる）
  searchManager = new Microsoft.Maps.Search.SearchManager(map);
  //Geocode：住所から検索
  geocodeQuery($(".where_to").val());
   });
  //4.Geocode:住所から検索
  geocodeQuery(document.getElementsByClassName("where_to").value);
    //住所緯度から住所を取得
    function geocodeQuery(query) {
        if(searchManager) {
            //住所から緯度経度を検索
            searchManager.geocode({
                where: query,       //検索文字列
                callback: function (r) { //検索結果を"( r )" の変数で取得
                    //最初の検索取得結果をMAPに表示
                    if (r && r.results && r.results.length > 0) {
                        //正確なサークルを作成する
                        const path = Microsoft.Maps.SpatialMath.getRegularPolygon(r.results[0].location, meter, 36, Microsoft.Maps.SpatialMath.Meters);
                        const lat = r.results[0].location.latitude;
                        const lon = r.results[0].location.longitude;
                        localStorage.setItem("lat_des",lat);
                        localStorage.setItem("lon_des",lon);
                        const poly = new Microsoft.Maps.Polygon(path,{
                        fillColor: style.fillColor,
                        strokeThickness: style.strokeWidth
                        });
                        map.entities.push(poly);
                        map.setView({ bounds: r.results[0].bestView});
                    }
                },
                errorCallback: function (e) {
                }
            });
        }
      }
})})

//登録ユーザーの住所を緯度経度に変換する
$(".search").on("click",function(){
//サークル設定
    const style = {
    pinColor:"#ff0000",
    fillColor:"rgba(255, 0 , 0, 0.5)",
    strokeWidth:5
    };
//サークルの大きさ
const meter = 3000;
Microsoft.Maps.loadModule('Microsoft.Maps.Search', function () {
Microsoft.Maps.loadModule("Microsoft.Maps.SpatialMath", function () {
  //searchManagerインスタンス化（Geocode,ReverseGeocodeが使用可能になる）
  searchManager = new Microsoft.Maps.Search.SearchManager(map);
  //Geocode：住所から検索
  geocodeQuery($(".where_to").val());
   });
  //4.Geocode:住所から検索
  geocodeQuery(document.getElementsByClassName("where_to").value);
    //住所緯度から住所を取得
    function geocodeQuery(query) {
        if(searchManager) {
            //住所から緯度経度を検索
            searchManager.geocode({
                where: query,       //検索文字列
                callback: function (r) { //検索結果を"( r )" の変数で取得
                    //最初の検索取得結果をMAPに表示
                    if (r && r.results && r.results.length > 0) {
                        //正確なサークルを作成する
                        const path = Microsoft.Maps.SpatialMath.getRegularPolygon(r.results[0].location, meter, 36, Microsoft.Maps.SpatialMath.Meters);
                        const lat = r.results[0].location.latitude;
                        const lon = r.results[0].location.longitude;
                        localStorage.setItem("lat_des",lat);
                        localStorage.setItem("lon_des",lon);
                        const poly = new Microsoft.Maps.Polygon(path,{
                        fillColor: style.fillColor,
                        strokeThickness: style.strokeWidth
                        });
                        map.entities.push(poly);
                        map.setView({ bounds: r.results[0].bestView});
                    }
                },
                errorCallback: function (e) {
                }
            });
        }
      }
})})
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




////////////////////////////////////////////////////////////////////////ユーザー登録住所を抽出しておく////////////////////////////////////////////////////////////////////////////////////////

let email_box = [];
//入力地の中心座標を取得
$(".search").on("click",function(){
  $(".anslist").remove();
  setTimeout(() => {
  //出発値の範囲を取得
  const lat_max_dep = Number(localStorage.getItem("lat_dep"))+ 0.013520059461864;
  localStorage.setItem("lat_max_dep",lat_max_dep)
  const lat_min_dep = Number(localStorage.getItem("lat_dep"))- 0.013520059461864;
  localStorage.setItem("lat_min_dep",lat_min_dep)
  const lon_max_dep = Number(localStorage.getItem("lon_dep"))+ 0.016449607073236;
  localStorage.setItem("lon_max_dep",lon_max_dep)
  const lon_min_dep = Number(localStorage.getItem("lon_dep"))- 0.016449607073236;
  localStorage.setItem("lon_min_dep",lon_min_dep)
  //到着地の範囲を取得
  const lat_max_des = Number(localStorage.getItem("lat_des"))+ 0.013520059461864;
  localStorage.setItem("lat_max_des",lat_max_des)
  const lat_min_des = Number(localStorage.getItem("lat_des"))- 0.013520059461864;
  localStorage.setItem("lat_min_des",lat_min_des)
  const lon_max_des = Number(localStorage.getItem("lon_des"))+ 0.016449607073236;
  localStorage.setItem("lon_max_des",lon_max_des)
  const lon_min_des = Number(localStorage.getItem("lon_des"))- 0.016449607073236;
  localStorage.setItem("lon_min_des",lon_min_des)
}, 1000);
})
  onChildAdded(dbRef_add,function(database){
  const datas = database.val();
  const company = datas["company"]; 
  const address = datas["place"];
  const email = datas["email"];
  Microsoft.Maps.loadModule('Microsoft.Maps.Search', function () {
  Microsoft.Maps.loadModule("Microsoft.Maps.SpatialMath", function () {
  searchManager = new Microsoft.Maps.Search.SearchManager(map);
  geocodeQuery(address);
    //住所緯度から住所を取得

    function geocodeQuery(query) {
        if(searchManager) {
            //住所から緯度経度を検索
            searchManager.geocode({
                where: query,
                callback: function (r) { 
                    if (r && r.results && r.results.length > 0) {
                        const lat = Number(r.results[0].location.latitude);
                        const lon = Number(r.results[0].location.longitude);
                    $(".search").on("click",function(){
                    setTimeout(() => {
                    ////if分岐で緯度経度を検索して、localstrageの入力地と比較
                    //出発範囲
                    const lat_max_dep = Number(localStorage.getItem("lat_max_dep"));
                    const lat_min_dep = Number(localStorage.getItem("lat_min_dep"));
                    const lon_max_dep = Number(localStorage.getItem("lon_max_dep"));
                    const lon_min_dep = Number(localStorage.getItem("lon_min_dep"));
                    //到着範囲
                    const lat_max_des = Number(localStorage.getItem("lat_max_des"));
                    const lat_min_des = Number(localStorage.getItem("lat_min_des"));
                    const lon_max_des = Number(localStorage.getItem("lon_max_des"));
                    const lon_min_des = Number(localStorage.getItem("lon_min_des"));
                    if(lat_max_dep >= lat && lat_min_dep <= lat && lon_max_dep >= lon && lon_min_dep <= lon){
                      $(".list_box").append(`<div class="ans anslist">
                                             <li class="company_name">
                                             <div style="width:100%; display:flex; flex-wrap:wrap; justify-content:space-between"><p>会社名</p><p>${company}</p></div>
                                             <div style="width:100%; display:flex; flex-wrap:wrap; justify-content:space-between"><p>所在地</p><p>${address}</p></div>
                                            </li>
                                            </div>`);
                      // $(".email_address").text(`<div class="mail_send">${email}</div>`)
                      // $(".email_address").text(`${email}`);
                      // $(".email_address").append(`${email}<br>`);
                      email_box.push(`${email}`)
                      localStorage.setItem("email_suspend",JSON.stringify(email_box));
                      // $(".email").val(`${email}`);



                                            
                    }
                    else if(lat_max_des >= lat && lat_min_des <= lat && lon_max_des >= lon && lon_min_des <= lon){
                      $(".list_box").append(`<div class="ans anslist">
                                             <li class="company_name">
                                             <div style="width:100%; display:flex; flex-wrap:wrap; justify-content:space-between"><p>会社名</p><p>${company}</p></div>
                                             <div style="width:100%; display:flex; flex-wrap:wrap; justify-content:space-between"><p>所在地</p><p>${address}</p></div>
                                            </li>
                                            </div>`);
                      // $(".email_address").text(`${email}`)
                      // $(".email_address").append(`${email}`);
                      email_box.push(`${email}`)
                      localStorage.setItem("email_suspend",JSON.stringify(email_box));


                    }
                    }, 2000);
                    })
                    }
                },
                errorCallback: function (e) {
                }
            });
        }
      }
  }
  
  )}
  
  )})
////////////////////////////////////////////////////geocodeで名称から緯度経度を算出////////////////////////////////////////////////////////////////////////////////////////////////////////////




////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////値を下の項目に代入する//////////////////////////////////////////////////////////////////////////////////
//////////////above plan to use 
$(".search").on("click",function(){
  const weight = $(".weight").val();
  const length = $(".length").val();
  const width = $(".width").val();
  const height = $(".height").val();
  const price = $(".price").val();
  $(".ans_wei").text(weight + $(".wei_unit").val());
  $(".ans_len").text(length + $(".len_unit").val());
  $(".ans_wid").text(width + $(".wid_unit").val());
  $(".ans_hei").text(height + $(".hei_unit").val());
  $(".ana_wei").text(weight + $(".wei_unit").val());
  $(".ana_len").text(length + $(".len_unit").val());
  $(".ana_wid").text(width + $(".wid_unit").val());
  $(".ana_hei").text(height + $(".hei_unit").val());
});

////////////////above Usage
$(".search").on("click",function usage(remain){
  const track = $(".abo_track_kind").val();
  const track_load = track.replace(/[^0-9]/g,"");
  const ans_wei = $(".ans_wei").val();
  const wei = $(".weight").val() + $(".wei_unit").val();

if(localStorage.getItem("amount")== 0 ){//一回目のサーチ適用時
  if(wei.slice(-2)=="kg"){
  const remain = (track_load*1000) - $(".weight").val();
  $(".ans_wei_usage").text(remain + "kg");
  localStorage.setItem("amount",remain);
  }else{
    const remain = (track_load*1000) - ($(".weight").val()*1000);
  $(".ans_wei_usage").text(remain +"kg");
  localStorage.setItem("amount",remain);
  }
}else{//二回目以降のサーチ適用時
  if(wei.slice(-2)=="kg"){
    const amount = localStorage.getItem("amount");
    const remain = amount - $(".weight").val();
    localStorage.setItem("amount",remain);
    const local = localStorage.getItem("amount");
    $(".ans_wei_usage").text(remain +"kg");
 }
  else{
    const amount = localStorage.getItem("amount");
    const remain = amount - ($(".weight").val()*1000);
    localStorage.setItem("amount",remain);
    $(".ans_wei_usage").text(remain +"kg");
  }
}
})



/////////////side plan to use
$(".search").on("click",function(){
  const weight = $(".weight").val();
  const length = $(".length").val();
  const width = $(".width").val();
  const height = $(".height").val();
  const price = $(".price").val();
  $(".ana_wei").text(weight + $(".wei_unit").val());
  $(".ana_len").text(length + $(".len_unit").val());
  $(".ana_wid").text(width + $(".wid_unit").val());
  $(".ana_hei").text(height + $(".hei_unit").val());
});

/////////////side Usage
$(".search").on("click",function usage(remain){
  const track = $(".abo_track_kind").val();
  const track_load = track.replace(/[^0-9]/g,"");
  const ana_wei = $(".ana_wei").val();
  const wei = $(".weight").val() + $(".wei_unit").val();

if(localStorage.getItem("amount_a")== 0 ){//一回目のサーチ適用時
  if(wei.slice(-2)=="kg"){
  const remain_a = (track_load*1000) - $(".weight").val();
  $(".ana_wei_usage").text(remain_a + "kg");
  localStorage.setItem("amount_a",remain_a);
  }else{
    const remain_a = (track_load*1000) - ($(".weight").val()*1000);
  $(".ana_wei_usage").text(remain_a +"kg");
  localStorage.setItem("amount_a",remain_a);
  }
}else{//二回目以降のサーチ適用時
  if(wei.slice(-2)=="kg"){
    const amount = localStorage.getItem("amount_a");
    const remain_a = amount - $(".weight").val();
    localStorage.setItem("amount_a",remain_a);
    const local = localStorage.getItem("amount_a");
    $(".ana_wei_usage").text(remain_a +"kg");
 }
  else{
    const amount = localStorage.getItem("amount_a");
    const remain_a = amount - ($(".weight").val()*1000);
    localStorage.setItem("amount_a",remain_a);
    $(".ana_wei_usage").text(remain_a +"kg");
  }
}
})


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////canvasに図形を入れる/////////////////////////////////////////////////////////////////////////////////////
//canvasに記載可能にする
const canvas_abo = document.getElementById("canvas_ans");
const {width_abo,height_abo} = canvas_abo;
const ctx_abo = canvas_abo.getContext("2d");
ctx_abo.translate( 0 , 150 );
ctx_abo.scale(1, -1);
const canvas_side = document.getElementById("canvas_ans");
const {width_side,height_side} = canvas_side;
const ctx_side = canvas_side.getContext("2d");
ctx_side.translate( 0 , 150 );
ctx_side.scale(1, -1);

//side canvasに記載する
const canvas_side_a = document.getElementById("canvas_ana");
const {width_side_a,height_side_a} = canvas_side;
const ctx_side_a = canvas_side_a.getContext("2d");
ctx_side_a.translate( 0 , 150 );
ctx_side_a.scale(1, -1);




let data = [];
let i = 0;
//入力された値をfirebaseに登録する（車種別に登録値が四角のサイズが異なる）
$(".search").on("click",function(){
  if($(".select_track").val()=="平ボディ" && $(".abo_track_kind").val()=="4MT"){//平4MT
  const weight = $(".weight").val();
  //above用の数値計算
  const length = $(".length").val()/6200*300;
  const width = $(".width").val()/2130*150;
  //side用の数値計算
  const height = $(".height").val()/2800*150;
  const load = {
    abo_x:length,
    abo_y:width,
    sid_x:length,
    sid_y:height,
    count: i,
  }
  data.push(load);
  localStorage.setItem("point",JSON.stringify(data))
  const dataJson = localStorage.getItem("point");
  const data_Json = JSON.parse(dataJson);
  const data_length = data_Json.length;
  let array = [];
  //配列内のデータ並び替えを実施//////////////////////////////obj内のcountの順番を変える
    for(let i = 0; i < data_length; i++){
    array.push(data_Json[i]["abo_y"]);
    array.sort(function(first,second){
      return second - first;
      });
    }
    //元々の値を取得→abo_y/abo_xが一致する値で分岐して、対象の配列番号を上からcount1から高い順に代入
    for(let i = 0; data_length >i; i++){
      const array_data = array[i];
        for(let r = 0; data_length > r; r++){
        const ori_data = data_Json[r]["abo_y"];
          if(array_data==ori_data){
          data_Json[r]["count"]= i;
          localStorage.setItem("point",JSON.stringify(data_Json));
          }else{
          }
        }
    }
  i =i+1;
  return i,data; 
 }
 else if($(".select_track").val()=="平ボディ" && $(".abo_track_kind").val()=="10MT"){//平10MT
  const weight = $(".weight").val();
  //above用の数値計算
  const length = $(".length").val()/9600*300;
  const width = $(".width").val()/2300*150;
  //side用の数値計算
  const height = $(".height").val()/2900*150;
  const load = {
    abo_x:length,
    abo_y:width,
    sid_x:length,
    sid_y:height,
    count: i,
  }
  data.push(load);
  localStorage.setItem("point",JSON.stringify(data))
  const dataJson = localStorage.getItem("point");
  const data_Json = JSON.parse(dataJson);
  const data_length = data_Json.length;
  let array = [];
  //配列内のデータ並び替えを実施//////////////////////////////obj内のcountの順番を変える
    for(let i = 0; i < data_length; i++){
    array.push(data_Json[i]["abo_y"]);
    array.sort(function(first,second){
      return second - first;
      });
    }
    console.log(array);//大きい順に並べ替え完了
    //元々の値を取得→abo_y/abo_xが一致する値で分岐して、対象の配列番号を上からcount1から高い順に代入
    for(let i = 0; data_length >i; i++){
      const array_data = array[i];
        for(let r = 0; data_length > r; r++){
        const ori_data = data_Json[r]["abo_y"];
          if(array_data==ori_data){
            data_Json[r]["count"]= i;
            localStorage.setItem("point",JSON.stringify(data_Json));
          }else{
          }
        }
  }
  i =i+1;
  return i,data; 
 }
 else if($(".select_track").val()=="平ボディ" && $(".abo_track_kind").val()=="20MT"){//平20MT
  const weight = $(".weight").val();
  //above用の数値計算
  const length = $(".length").val()/10000*300;
  const width = $(".width").val()/2400*150;
  //side用の数値計算
  const height = $(".height").val()/3000*150;
  const load = {
    abo_x:length,
    abo_y:width,
    sid_x:length,
    sid_y:height,
    count: i,
  }
  data.push(load);
  localStorage.setItem("point",JSON.stringify(data))
  const dataJson = localStorage.getItem("point");
  const data_Json = JSON.parse(dataJson);
  const data_length = data_Json.length;
  let array = [];
  //配列内のデータ並び替えを実施//////////////////////////////obj内のcountの順番を変える
    for(let i = 0; i < data_length; i++){
    array.push(data_Json[i]["abo_y"]);
    array.sort(function(first,second){
      return second - first;
      });
    }
    console.log(array);//大きい順に並べ替え完了
    //元々の値を取得→abo_y/abo_xが一致する値で分岐して、対象の配列番号を上からcount1から高い順に代入
    for(let i = 0; data_length >i; i++){
      const array_data = array[i];
        for(let r = 0; data_length > r; r++){
        const ori_data = data_Json[r]["abo_y"];
          if(array_data==ori_data){
            data_Json[r]["count"]= i;
            localStorage.setItem("point",JSON.stringify(data_Json));
          }else{
          }
        }
  }
  i =i+1;
  return i,data; 
 }
 else if($(".select_track").val()=="バン" && $(".abo_track_kind").val()=="4MT"){//バン4MT
  const weight = $(".weight").val();
  //above用の数値計算
  const length = $(".length").val()/6200*300;
  const width = $(".width").val()/2130*150;
  //side用の数値計算
  const height = $(".height").val()/2800*150;
  const load = {
    abo_x:length,
    abo_y:width,
    sid_x:length,
    sid_y:height,
    count: i,
  }
  data.push(load);
  localStorage.setItem("point",JSON.stringify(data));
  const dataJson = localStorage.getItem("point");
  const data_Json = JSON.parse(dataJson);
  const data_length = data_Json.length;
  let array = [];
  //配列内のデータ並び替えを実施//////////////////////////////obj内のcountの順番を変える
    for(let i = 0; i < data_length; i++){
    array.push(data_Json[i]["abo_y"]);
    array.sort(function(first,second){
      return second - first;
      });
    }
    console.log(array);//大きい順に並べ替え完了
    //元々の値を取得→abo_y/abo_xが一致する値で分岐して、対象の配列番号を上からcount1から高い順に代入
    for(let i = 0; data_length >i; i++){
      const array_data = array[i];
        for(let r = 0; data_length > r; r++){
        const ori_data = data_Json[r]["abo_y"];
          if(array_data==ori_data){
            data_Json[r]["count"]= i;
            localStorage.setItem("point",JSON.stringify(data_Json));
          }else{
          }
        }
  }
  i =i+1;
  return i,data; 
 }
 else if($(".select_track").val()=="バン" && $(".abo_track_kind").val()=="10MT"){//バン10MT
  const weight = $(".weight").val();
  //above用の数値計算
  const length = $(".length").val()/9600*300;
  const width = $(".width").val()/2300*150;
  //side用の数値計算
  const height = $(".height").val()/2900*150;
  const load = {
    abo_x:length,
    abo_y:width,
    sid_x:length,
    sid_y:height,
    count: i,
  }
  data.push(load);
  localStorage.setItem("point",JSON.stringify(data))
  const dataJson = localStorage.getItem("point");
  const data_Json = JSON.parse(dataJson);
  const data_length = data_Json.length;
  let array = [];
  //配列内のデータ並び替えを実施//////////////////////////////obj内のcountの順番を変える
    for(let i = 0; i < data_length; i++){
    array.push(data_Json[i]["abo_y"]);
    array.sort(function(first,second){
      return second - first;
      });
    }
    console.log(array);//大きい順に並べ替え完了
    //元々の値を取得→abo_y/abo_xが一致する値で分岐して、対象の配列番号を上からcount1から高い順に代入
    for(let i = 0; data_length >i; i++){
      const array_data = array[i];
        for(let r = 0; data_length > r; r++){
        const ori_data = data_Json[r]["abo_y"];
          if(array_data==ori_data){
            data_Json[r]["count"]= i;
            localStorage.setItem("point",JSON.stringify(data_Json));
          }else{
          }
        }
  }
  i =i+1;
  return i,data; 
 }
 else if($(".select_track").val()=="バン" && $(".abo_track_kind").val()=="20MT"){//バン20MT
  const weight = $(".weight").val();
  //above用の数値計算
  const length = $(".length").val()/10000*300;
  const width = $(".width").val()/2400*150;
  //side用の数値計算
  const height = $(".height").val()/3000*150;
  const load = {
    abo_x:length,
    abo_y:width,
    sid_x:length,
    sid_y:height,
    count: i,
  }
  data.push(load);
  localStorage.setItem("point",JSON.stringify(data))
  const dataJson = localStorage.getItem("point");
  const data_Json = JSON.parse(dataJson);
  const data_length = data_Json.length;
  let array = [];
  //配列内のデータ並び替えを実施//////////////////////////////obj内のcountの順番を変える
    for(let i = 0; i < data_length; i++){
    array.push(data_Json[i]["abo_y"]);
    array.sort(function(first,second){
      return second - first;
      });
    }
    //元々の値を取得→abo_y/abo_xが一致する値で分岐して、対象の配列番号を上からcount1から高い順に代入
    for(let i = 0; data_length >i; i++){
      const array_data = array[i];
        for(let r = 0; data_length > r; r++){
        const ori_data = data_Json[r]["abo_y"];
          if(array_data==ori_data){
            data_Json[r]["count"]= i;
            localStorage.setItem("point",JSON.stringify(data_Json));
          }else{
          }
        }
  }
  i =i+1;
  return i,data; 
 }
})
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////図形表示////////////////////////////////////////////////////////////////////////////////////////////////////////

ctx_abo.fillStyle = "red";
ctx_side_a.fillStyle ="red";

//各行の高さを設定関数を設計
let arr_line_height = [];
function line_height(y_one,y_two,y_three,y_four){
setTimeout(() => {
localStorage.setItem("one",0);
localStorage.setItem("two",0);
localStorage.setItem("three",0);
localStorage.setItem("four",0)
const item = localStorage.getItem("point");
const item_J = JSON.parse(item);
let arr1 = Number(localStorage.getItem("arr1"));
let arr2 = Number(localStorage.getItem("arr2"));
let arr3 = Number(localStorage.getItem("arr3"));
let arr4 = Number(localStorage.getItem("arr4"));
y_one = Number(item_J[0]["abo_y"]);
localStorage.setItem("one",y_one);
for(let i = 0; i < 3; i++){
if(arr2 != 0 && i==0){y_two = Number(item_J[arr1]["abo_y"]);
localStorage.setItem("two",y_two);
}
else if(arr3 != 0 && i==1){y_three = Number(item_J[arr1+arr2]["abo_y"]);
localStorage.setItem("three",y_three);
}
else if(arr4 != 0 && i==2){y_four = Number(item_J[arr1+arr2+arr3]["abo_y"]);
localStorage.setItem("four",y_four);
}
else{}
}
}, 1500);
};
//行高さ取得を実行
$(".search").on("click",function(){
localStorage.setItem("line_height",0);
line_height();
});
$(".search").on("click",function(){
  localStorage.setItem("count_sum","0")
  localStorage.setItem("arr1","0")
  localStorage.setItem("arr2","0")
  localStorage.setItem("arr3","0")
  localStorage.setItem("arr4","0")

  const item = localStorage.getItem("point");
  const item_J = JSON.parse(item);
  let len = item_J.length;
  ctx_abo.clearRect(0,0,300,150);
  ctx_side_a.clearRect(0,0,300,150);
  //localstreageをcountに沿って降順に変更する
  setTimeout(() => {
  item_J.sort((a,b)=>a.count- b.count);
  localStorage.setItem("point",JSON.stringify(item_J))
  //localstrage内のx軸方向で何個入るのかを予め計算する
  }, 500);

  ///////////////x軸方向の制御
    let arr = [];
    let arr_y= [];
    let arr_hei= [];
  setTimeout(() => {
    for(let i = 0 ; i < item_J.length; i ++){
    arr.push(item_J[i]["abo_x"])
    arr_y.push(item_J[i]["abo_y"])
    arr_hei.push(item_J[i]["sid_y"])
    }
    //length制御
    for(let i = 1; i <= item_J.length; i++){
      let arr_pre =  arr.slice(0,i);
      let sum = arr_pre.reduce((a,b) => {
      let sum_num = a+b;
      localStorage.setItem("count_sum",sum_num);
      return sum_num;
      })
      if(localStorage.getItem("count_sum")<=300){
        localStorage.setItem("arr1",i);
      }
      else if(301<=localStorage.getItem("count_sum") && localStorage.getItem("count_sum")<=600){
        localStorage.setItem("arr2",i-localStorage.getItem("arr1"));
      }    
      else if(601<= localStorage.getItem("count_sum")&& localStorage.getItem("count_sum")<=900){
        const l = i-localStorage.getItem("arr1");
        localStorage.setItem("arr3",l-localStorage.getItem("arr2"));
      }
      else if(901<= localStorage.getItem("count_sum")&& localStorage.getItem("count_sum")<=1200){
        const l = i-localStorage.getItem("arr1");
        const k = l-localStorage.getItem("arr2");
        localStorage.setItem("arr4",k-localStorage.getItem("arr3"));
      }else{
      }
    }

  }, 1000);
  setTimeout(() => {
    //配列の個数取得用
    const Item = localStorage.getItem("point");
    const Item_Json = JSON.parse(Item);
    const arr1 = Number(localStorage.getItem("arr1"));
    const arr2 = Number(localStorage.getItem("arr2"));
    const arr3 = Number(localStorage.getItem("arr3"));
    const arr4 = Number(localStorage.getItem("arr4"));
    const line_data_J = localStorage.getItem("line_height");
    const line_data = JSON.parse(line_data_J); 
    //y軸方向制御データ取得
    const hei_1 = Number(localStorage.getItem("one"));
    const hei_2 = Number(localStorage.getItem("two"));
    const hei_3 = Number(localStorage.getItem("three"));
    const hei_4 = Number(localStorage.getItem("four"));

    ////1行目の処理
    for(let i = 0; arr1 > i; i++){//x軸に入るぶんだけ繰り返し(arr1の値分)
        for(let r = 0; r < 301; r++){//x軸方向にマイナスで色彩検索をかける
            if(ctx_abo.getImageData(r,0,1,1).data[0]!="255" && arr1 >i && hei_1 <= 150){//条件②y軸が0で並行移動するときの処理
              //ABO
              const x = item_J[i]["abo_x"];
              const y = item_J[i]["abo_y"];
              ctx_abo.strokeRect(r+1,0,x,y);  
              ctx_abo.fillRect(r+1,0,x,y);  
              //SIDE
              if(item_J[i]["sid_y"]<=150){
              const side_len = item_J[i]["sid_x"];
              const side_hei = item_J[i]["sid_y"];
              ctx_side_a.strokeRect(r,0,side_len,side_hei);
              ctx_side_a.fillRect(r,0,side_len,side_hei);
              };
              i = i +1;
            }
            else{
          }
      }
      }
      ////2段目の処理を書く(arr2でスタート)
      for(let i = 1; arr2 >= i; i++){//x軸に入るぶんだけ繰り返し(arr2の値分)
        let num = i+Number(arr1)-1;
        let count = Number(num);
        const t = item_J[0]["abo_y"];
        for(let r = 0; r < 301; r++){//x軸方向にマイナスで色彩検索をかける
            if(ctx_abo.getImageData(r,t+1,1,1).data[0]!="255" && arr2 >=i  && hei_1+hei_2 <= 150){//条件②y軸が0で並行移動するときの処理  
              //ABO
              const x = item_J[count]["abo_x"];
              const y = item_J[count]["abo_y"];
              ctx_abo.strokeRect(r+1,t,x,y);  
              ctx_abo.fillRect(r+1,t,x,y); 
              //SIDE
              if(item_J[i]["sid_y"]<=150){
              const side_len = item_J[count]["sid_x"];
              const side_hei = item_J[count]["sid_y"];
              ctx_side_a.strokeRect(r,0,side_len,side_hei);
              ctx_side_a.fillRect(r,0,side_len,side_hei);
              };
              i = i +1;
              count = count +1;
            }
            else{
            }
          }
      }
       ////3段目の処理を書く(arr3でスタート)
       for(let i = 1; arr3 >= i; i++){//x軸に入るぶんだけ繰り返し(arr3の値分)
        let num = i+Number(arr2)+Number(arr3)-1;
        let count = Number(num);
        let high1 =Number(arr1);
        const high_num1 = Number(high1);
        //1-2行目の高さを取得
        const t = item_J[0]["abo_y"] + item_J[high_num1]["abo_y"];
        for(let r = 0; r < 301; r++){//x軸方向にマイナスで色彩検索をかける
          // for(let t = 150; t >= 0; t--){//y軸方向に色彩検索をかける
            if(ctx_abo.getImageData(r,t+1,1,1).data[0]!="255" && arr3 >=i && hei_1+hei_2+hei_3 <= 150){//条件②y軸が0で並行移動するときの処理  
              //ABO
              const x = item_J[count]["abo_x"];
              const y = item_J[count]["abo_y"];
              ctx_abo.strokeRect(r+1,t,x,y);  
              ctx_abo.fillRect(r+1,t,x,y);  
              //SIDE
              if(item_J[i]["sid_y"]<=150){
              const side_len = item_J[count]["sid_x"];
              const side_hei = item_J[count]["sid_y"];
              ctx_side_a.strokeRect(r,0,side_len,side_hei);
              ctx_side_a.fillRect(r,0,side_len,side_hei);
              };
              i = i +1;
              count = count +1;
            }
            else{
            }
          }
      }
        ////4段目の処理を書く(arr4でスタート)
        for(let i = 1; arr4 >= i; i++){//x軸に入るぶんだけ繰り返し(arr4の値分)
        let num = i+Number(arr1)+Number(arr2)+Number(arr3)-1;
        let count = Number(num);
        //2行目の高さ取得
        let high1 =Number(arr1);
        const high_num1 = Number(high1);
        //3行目の高さ取得
        let high2 = Number(arr2) + Number(arr1);
        const high_num2 = Number(high2);
        //1行目-3行目までの高さを取得
        const t = item_J[0]["abo_y"] + item_J[high_num1]["abo_y"] +item_J[high_num2]["abo_y"];
        for(let r = 0; r < 301; r++){//x軸方向にマイナスで色彩検索をかける
          // for(let t = 150; t >= 0; t--){//y軸方向に色彩検索をかける
            if(ctx_abo.getImageData(r,t+1,1,1).data[0]!="255" && arr4 >=i  && hei_1+hei_2+hei_3+hei_4 <= 150){//条件②y軸が0で並行移動するときの処理  
              //ABO
              const x = item_J[count]["abo_x"];
              const y = item_J[count]["abo_y"];
              ctx_abo.strokeRect(r+1,t,x,y);  
              ctx_abo.fillRect(r+1,t,x,y);  
              //SIDE
              if(item_J[i]["sid_y"]<=150){
              const side_len = item_J[count]["sid_x"];
              const side_hei = item_J[count]["sid_y"];
              ctx_side_a.strokeRect(r,0,side_len,side_hei);
              ctx_side_a.fillRect(r,0,side_len,side_hei);
              };
              i = i +1;
              count = count +1;
            }
            else{
            }
          }
      }
    }, 2000);
})


// })

//reload時にリアルタイムデータベースデータを削除（削除前アラートの作成）
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////メール送信/////////////////////////////////////////////////////////////////////////////////////////////////

$(".confirm").on("click",function(e){
     e.preventDefault();
     const email_address = localStorage.getItem("email_suspend");
     const email_address_J = JSON.parse(email_address);
     console.log(email_address_J);
     for(let i = 1; i < email_address_J.length ; i++){
      //sendメールの処理
     }

});
$(".reject").on("click",function(e){
  e.preventDefault();
  })

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////submitでデータ登録住所3km以内にメール///////////////////////////////////////////////////////////////////////////////////////////////////

$(".submit").on("click",function(){
  $(".submit_tab").slideDown();
  const date = ($(".year").val() + "/" + $(".month").val() + "/" + $(".date").val());
  const money = ($(".price").val() + $(".pri_unit").val());
  const amount = localStorage.getItem("amount") +"kg";
  $(".dated").text(`${date}`);
  $(".money").text(`${money}`);
  $(".amount").text(`${amount}`);
});
$(".reject").on("click",function(){
  $(".submit_tab").slideUp();
});





////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//リロード時にリセットする・・利用方法を表示する
$(window).on("load",function(){
  localStorage.setItem("amount",0);
  localStorage.setItem("lat_dep",0);
  localStorage.setItem("lon_dep",0);
  localStorage.setItem("lat_des",0);
  localStorage.setItem("lon_des",0);
  localStorage.setItem("point",0);
  localStorage.setItem("arr1",0);
  localStorage.setItem("arr2",0);
  localStorage.setItem("arr3",0);
  localStorage.setItem("arr4",0);
  localStorage.setItem("count_sum",0);
  localStorage.setItem("one",0);
  localStorage.setItem("two",0);
  localStorage.setItem("three",0);
  localStorage.setItem("four",0);
  localStorage.setItem("lat_max_dep",0);
  localStorage.setItem("lat_min_dep",0);
  localStorage.setItem("lon_max_dep",0);
  localStorage.setItem("lon_min_dep",0);
  localStorage.setItem("lat_max_des",0);
  localStorage.setItem("lat_min_des",0);
  localStorage.setItem("lon_max_des",0);
  localStorage.setItem("lon_min_des",0);
  localStorage.setItem("email_suspend",0)
  $(".opening").slideDown();
})
$(".close").on("click",function(){
  $(".opening").remove();
})
$(".search").on("click",function(){
  setTimeout(() => {
  $(".where_to").val("入力済み");
  $(".where_from").val("入力済み");
  localStorage.setItem("lat_max_dep",0);
  localStorage.setItem("lat_min_dep",0);
  localStorage.setItem("lon_max_dep",0);
  localStorage.setItem("lon_min_dep",0);
  localStorage.setItem("lat_max_des",0);
  localStorage.setItem("lat_min_des",0);
  localStorage.setItem("lon_max_des",0);
  localStorage.setItem("lon_min_des",0);
}, 5000);

})
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



</script>
</body>